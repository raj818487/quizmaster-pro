<div class="user-access-management">
  <!-- System Status Bar (simplified header) -->
  <div class="system-status-bar" *ngIf="actionLoading">
    <div class="loading-indicator">
      <span class="loading-icon">⏳</span>
      <span class="loading-message">{{ loadingMessage }}</span>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="quick-actions-bar">
    <button
      class="btn btn-primary"
      (click)="showCreateUser = true"
      [disabled]="showCreateUser"
    >
      <i class="icon">➕</i> Add New User
    </button>
    <button class="btn btn-secondary" (click)="exportUsers()">
      <i class="icon">📊</i> Export Users
    </button>
    <button class="btn btn-secondary" (click)="refreshUsers()">
      <i class="icon">🔄</i> Refresh
    </button>
    <div class="search-box">
      <input
        type="text"
        placeholder="Search users..."
        [(ngModel)]="searchTerm"
        (input)="filterUsers()"
        class="search-input"
      />
      <i class="search-icon">🔍</i>
    </div>
  </div>

  <!-- Bulk Actions -->
  <div class="bulk-actions-bar" *ngIf="selectedUsers.length > 0">
    <div class="selection-info">
      <span class="badge">{{ selectedUsers.length }} users selected</span>
      <button class="btn btn-link" (click)="clearSelection()">
        Clear selection
      </button>
    </div>
    <div class="bulk-buttons">
      <button class="btn btn-success" (click)="bulkUpdateStatus('active')">
        ✅ Activate Selected
      </button>
      <button class="btn btn-warning" (click)="bulkUpdateStatus('suspended')">
        🚫 Suspend Selected
      </button>
      <button class="btn btn-danger" (click)="bulkDelete()">
        🗑️ Delete Selected
      </button>
    </div>
  </div>

  <!-- Create User Form -->
  @if (showCreateUser) {
  <div class="create-user-card card">
    <div class="card-header">
      <h3>🆕 Create New User</h3>
      <button class="btn btn-link" (click)="cancelCreateUser()">
        ✕ Cancel
      </button>
    </div>
    <div class="card-body">
      <form (ngSubmit)="createUser()" #userForm="ngForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="username">Username *</label>
            <input
              type="text"
              id="username"
              [(ngModel)]="newUser.username"
              name="username"
              placeholder="Enter username"
              required
              #usernameField="ngModel"
            />
            @if (usernameField.invalid && usernameField.touched) {
            <div class="error-message">Username is required</div>
            }
          </div>

          <div class="form-group">
            <label for="password">Password *</label>
            <input
              type="password"
              id="password"
              [(ngModel)]="newUser.password"
              name="password"
              placeholder="Enter password (min 6 characters)"
              required
              minlength="6"
              #passwordField="ngModel"
            />
            @if (passwordField.invalid && passwordField.touched) {
            <div class="error-message">
              @if (passwordField.errors?.['required']) {
                Password is required
              }
              @if (passwordField.errors?.['minlength']) {
                Password must be at least 6 characters long
              }
            </div>
            }
          </div>

          <div class="form-group">
            <label for="role">Role *</label>
            <select id="role" [(ngModel)]="newUser.role" name="role" required>
              <option value="user">👤 Regular User</option>
              <option value="admin">👑 Administrator</option>
            </select>
          </div>
        </div>

        <div class="form-actions">
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="userForm.invalid || creating"
          >
            @if (creating) {
            <i class="icon spinning">⏳</i> Creating... } @else {
            <i class="icon">✨</i> Create User }
          </button>
          <button
            type="button"
            class="btn btn-secondary"
            (click)="cancelCreateUser()"
          >
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
  }

  <!-- Users Table -->
  <div class="users-table-card card">
    <div class="card-header">
      <h3>📋 Users Directory</h3>
      <div class="table-controls">
        <select
          [(ngModel)]="filterRole"
          (change)="filterUsers()"
          class="filter-select"
        >
          <option value="">All Roles</option>
          <option value="admin">👑 Admins</option>
          <option value="user">👤 Users</option>
        </select>
        <select
          [(ngModel)]="filterStatus"
          (change)="filterUsers()"
          class="filter-select"
        >
          <option value="">All Status</option>
          <option value="active">✅ Active</option>
          <option value="inactive">❌ Inactive</option>
          <option value="suspended">🚫 Suspended</option>
        </select>
      </div>
    </div>

    <div class="card-body">
      @if (loading) {
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <p>Loading users...</p>
      </div>
      } @else { @if (filteredUsers.length === 0) {
      <div class="empty-state">
        <div class="empty-icon">👥</div>
        <h4>No Users Found</h4>
        <p>No users match your current filters.</p>
      </div>
      } @else {
      <div class="users-table">
        <div class="table-header">
          <div>User Info</div>
          <div>Role</div>
          <div>Status</div>
          <div>Actions</div>
        </div>

        @for (user of filteredUsers; track user.id) {
        <div
          class="table-row"
          [class.editing]="user._editing"
          [class.selected]="user.id && selectedUsers.includes(user.id)"
        >
          <!-- User Info Inline -->
          <div class="user-info-inline">
            <div class="user-avatar">
              {{ getUserInitials(user.username) }}
            </div>
            @if (!user._editing) {
            <div class="user-details-flow">
              <span class="user-name">{{ user.username }}</span>
              <span class="user-email">{{ user.email || "No email" }}</span>
              <span class="user-id">ID: {{ user.id }}</span>
            </div>
            } @else {
            <div class="user-edit-expanded">
              <div class="edit-row">
                <input
                  [(ngModel)]="user.username"
                  placeholder="Username"
                  class="edit-input-inline"
                />
                <input
                  [(ngModel)]="user.email"
                  placeholder="Email"
                  class="edit-input-inline"
                />
              </div>
              <div class="edit-row">
                <input
                  type="password"
                  [(ngModel)]="user.newPassword"
                  placeholder="New Password (leave empty to keep current)"
                  class="edit-input-inline password-input"
                />
                <input
                  type="password"
                  [(ngModel)]="user.confirmPassword"
                  placeholder="Confirm New Password"
                  class="edit-input-inline password-input"
                />
              </div>
              <div class="edit-info">
                <span class="user-id">ID: {{ user.id }}</span>
                <span class="password-hint">Leave password fields empty to keep current password</span>
              </div>
            </div>
            }
          </div>

          <!-- Role Inline -->
          <div class="role-inline">
            @if (!user._editing) {
            <div class="role-badge" [ngClass]="'role-' + user.role">
              {{ user.role === "admin" ? "ADMIN" : "USER" }}
            </div>
            } @else {
            <select [(ngModel)]="user.role" class="edit-select-inline">
              <option value="user">USER</option>
              <option value="admin">ADMIN</option>
            </select>
            }
          </div>

          <!-- Status Inline -->
          <div class="status-inline">
            @if (!user._editing) {
            <div
              class="status-badge"
              [ngClass]="'status-' + (user.status || 'active')"
            >
              {{ getStatusDisplay(user.status || "active").toUpperCase() }}
            </div>
            } @else {
            <select [(ngModel)]="user.status" class="edit-select-inline">
              <option value="active">ACTIVE</option>
              <option value="inactive">INACTIVE</option>
              <option value="suspended">SUSPENDED</option>
            </select>
            }
          </div>

          <!-- Actions Inline -->
          <div class="actions-inline">
            @if (!user._editing) {
            <div class="action-buttons-text">
              <button
                class="btn-text btn-edit"
                (click)="editUser(user)"
                [disabled]="user.role === 'admin' && !currentUserIsAdmin()"
                title="Edit user"
              >
                Edit
              </button>
              <span class="action-separator"></span>
              <button
                class="btn-text btn-activity"
                (click)="viewUserActivity(user)"
                title="View activity"
              >
                Activity
              </button>
              <span class="action-separator"></span>
              @if (user.status !== 'suspended') {
              <button
                class="btn-text btn-suspend"
                (click)="suspendUser(user)"
                [disabled]="user.role === 'admin'"
                title="Suspend user"
              >
                Suspend
              </button>
              } @else {
              <button
                class="btn-text btn-approve"
                (click)="activateUser(user)"
                title="Activate user"
              >
                Approve
              </button>
              }
              <span class="action-separator"></span>
              <button
                class="btn-text btn-delete"
                (click)="user.id !== undefined ? deleteUser(user.id) : null"
                [disabled]="user.role === 'admin' || user.id === undefined"
                title="Delete user"
              >
                Delete
              </button>
            </div>
            } @else {
            <div class="action-buttons-text">
              <button class="btn-text btn-approve" (click)="saveUser(user)">
                Save
              </button>
              <span class="action-separator"></span>
              <button
                class="btn-text btn-delete"
                (click)="cancelEdit(user)"
              >
                Cancel
              </button>
            </div>
            }
          </div>
        </div>
        }
      </div>

      <!-- Pagination -->
      <div class="pagination">
        <div class="pagination-info">
          Showing {{ filteredUsers.length }} of {{ users.length }} users
        </div>
        <div class="pagination-controls">
          <button
            class="btn btn-sm"
            (click)="previousPage()"
            [disabled]="currentPage === 1"
          >
            ← Previous
          </button>
          <span class="page-info"
            >Page {{ currentPage }} of {{ totalPages }}</span
          >
          <button
            class="btn btn-sm"
            (click)="nextPage()"
            [disabled]="currentPage === totalPages"
          >
            Next →
          </button>
        </div>
      </div>
      } }
    </div>
  </div>
</div>
